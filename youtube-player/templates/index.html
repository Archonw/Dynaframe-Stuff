<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Player</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .video-list {
            list-style: none;
            padding: 0;
        }
        .video-item {
            margin: 10px 0;
        }
        .controls {
            margin-top: 20px;
        }
        .video-item input[type="number"] {
            width: 60px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <h1>YouTube Player</h1>
    <div class="video-selection">
        <button onclick="loadVideos()">Load Videos</button>
        <button onclick="selectAll()">Select All</button>  
        <p id="loading-message" style="display: none; color: blue;">Videos werden geladen...</p>
        <ul class="video-list" id="video-list"></ul>
    </div>

    <div class="global-time">
        <label for="global-time">Global Time (Sec):</label>
        <input type="number" id="global-time" value="30">
        <button onclick="applyGlobalTime()">Apply Global Time</button>
    </div>
    
    <div class="controls">
        <button onclick="playVideos()">Play Selected Videos</button>
        <button onclick="stopPlayback()">Stop</button>
    </div>

    <div class="controls">
        <button onclick="window.location.href='/edit-urls'">Edit URLs</button>
    </div>

    <script>
        let selectedVideos = [];
        let videoTimes = {};

        function loadVideos() {
            const loadingMessage = document.getElementById('loading-message');
            loadingMessage.style.display = 'block'; 
            loadingMessage.textContent = "Videos are loading...";

            fetch('/load_videos')
                .then(response => response.json())
                .then(data => {
                    loadingMessage.style.display = 'none'; 

                    const videoList = document.getElementById('video-list');
                    videoList.innerHTML = '';  
                    if (data.status === "error") {
                        alert(data.message);
                    } else {
                        data.forEach((video, index) => {
                            const li = document.createElement('li');
                            li.className = 'video-item';
                            li.innerHTML = `
                                <input type="checkbox" value="${video.url}" onchange="updateSelection('${video.url}', ${index})" /> 
                                ${video.title} - 
                                <input type="number" id="time-${index}" value="${video.time}" oninput="updateTime('${video.url}', ${index})" /> Sec
                            `;
                            videoList.appendChild(li);
                        });
                    }
                })
                .catch(error => {
                    loadingMessage.style.display = 'none'; 
                    console.error('Error loading videos:', error);
                    alert("Fehler beim Laden der Videos!");
                });
        }

        function updateSelection(url, index) {
            const checkbox = document.querySelector(`input[type="checkbox"][value="${url}"]`);
            if (checkbox.checked) {
                selectedVideos.push(url);
            } else {
                selectedVideos = selectedVideos.filter(video => video !== url);
            }
        }

        function applyGlobalTime() {
            const globalTime = document.getElementById('global-time').value;
            selectedVideos.forEach((url, index) => {
                document.getElementById(`time-${index}`).value = globalTime;
                videoTimes[url] = globalTime;
            });
        }

        function playVideos() {
            const videosToPlay = selectedVideos.map(url => ({ url: url, time: videoTimes[url] || 30 }));
            fetch('/set_videos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ videos: videosToPlay })
            }).then(() => fetch('/play', { method: 'POST' }));
        }

        function stopPlayback() {
            fetch('/stop', { method: 'POST' });
        }

        function selectAll() {
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => checkbox.checked = true);
            selectedVideos = Array.from(document.querySelectorAll('input[type="checkbox"]')).map(cb => cb.value);
        }
    </script>
</body>
</html>
